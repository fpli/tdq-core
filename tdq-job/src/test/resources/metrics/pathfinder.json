{
  "id": "1",
  "name": "tdq_pathfinder_prod",
  "sources": [
    {
      "name": "kafka_pathfinder_rno",
      "type": "realtime.kafka",
      "config": {
        "rhs-parallelism": 125,
        "rhs-out-of-orderless": "5min",
        "rhs-idle-timeout": "5min",
        "startup-mode": "LATEST",
        "stream": "behavior.pathfinder",
        "topics": "behavior.pathfinder.events.total",
        "rheos-services-urls": "https://rheos-services.stratus.ebay.com",
        "event-time-field": "eventTimestamp",
        "deserializer": "com.ebay.tdq.connector.kafka.schema.PathFinderRawEventKafkaDeserializationSchema",
        "kafka-consumer": {
          "sasl.mechanism": "IAF",
          "security.protocol": "SASL_PLAINTEXT",
          "sasl.jaas.config": "io.ebay.rheos.kafka.security.iaf.IAFLoginModule required iafConsumerId=\"urn:ebay-marketplace-consumerid:68a97ac2-013b-4915-9ed7-d6ae2ff01618\" iafSecret=\"c4bb6fca-7ac5-46dd-b218-a49cb6307dbc\" iafEnv=\"production\";",
          "group.id": "tdq_pathfinder_prod",
          "bootstrap.servers": "rhs-glrvkiaa-kfk-rno-1.rheos-streaming-prod.svc.25.tess.io:9092,rhs-glrvkiaa-kfk-rno-2.rheos-streaming-prod.svc.25.tess.io:9092,rhs-glrvkiaa-kfk-rno-3.rheos-streaming-prod.svc.25.tess.io:9092,rhs-glrvkiaa-kfk-rno-4.rheos-streaming-prod.svc.25.tess.io:9092,rhs-glrvkiaa-kfk-rno-5.rheos-streaming-prod.svc.25.tess.io:9092",
          "partition.assignment.strategy": "org.apache.kafka.clients.consumer.RoundRobinAssignor",
          "max.poll.records": 5000,
          "fetch.max.bytes": 52428800,
          "receive.buffer": 8388608,
          "fetch.max.wait.ms": 100,
          "max.partition.fetch.bytes": 10485760,
          "auto.offset.reset": "latest"
        }
      }
    },
    {
      "name": "kafka_pathfinder_slc",
      "type": "realtime.kafka",
      "config": {
        "rhs-parallelism": 125,
        "rhs-out-of-orderless": "5min",
        "rhs-idle-timeout": "5min",
        "startup-mode": "LATEST",
        "stream": "behavior.pathfinder",
        "topics": "behavior.pathfinder.events.total",
        "rheos-services-urls": "https://rheos-services.stratus.ebay.com",
        "event-time-field": "eventTimestamp",
        "deserializer": "com.ebay.tdq.connector.kafka.schema.PathFinderRawEventKafkaDeserializationSchema",
        "kafka-consumer": {
          "sasl.mechanism": "IAF",
          "security.protocol": "SASL_PLAINTEXT",
          "sasl.jaas.config": "io.ebay.rheos.kafka.security.iaf.IAFLoginModule required iafConsumerId=\"urn:ebay-marketplace-consumerid:68a97ac2-013b-4915-9ed7-d6ae2ff01618\" iafSecret=\"c4bb6fca-7ac5-46dd-b218-a49cb6307dbc\" iafEnv=\"production\";",
          "group.id": "tdq_pathfinder_prod",
          "bootstrap.servers": "rhs-mwsvkiaa-kfk-slc-1.rheos-streaming-prod.svc.45.tess.io:9092,rhs-mwsvkiaa-kfk-slc-2.rheos-streaming-prod.svc.45.tess.io:9092,rhs-mwsvkiaa-kfk-slc-3.rheos-streaming-prod.svc.45.tess.io:9092,rhs-mwsvkiaa-kfk-slc-4.rheos-streaming-prod.svc.45.tess.io:9092,rhs-mwsvkiaa-kfk-slc-5.rheos-streaming-prod.svc.45.tess.io:9092",
          "partition.assignment.strategy": "org.apache.kafka.clients.consumer.RoundRobinAssignor",
          "max.poll.records": 5000,
          "fetch.max.bytes": 52428800,
          "receive.buffer": 8388608,
          "fetch.max.wait.ms": 100,
          "max.partition.fetch.bytes": 10485760,
          "auto.offset.reset": "latest"
        }
      }
    },
    {
      "name": "kafka_pathfinder_lvs",
      "type": "realtime.kafka",
      "config": {
        "rhs-parallelism": 125,
        "rhs-out-of-orderless": "5min",
        "rhs-idle-timeout": "5min",
        "startup-mode": "LATEST",
        "stream": "behavior.pathfinder",
        "topics": "behavior.pathfinder.events.total",
        "rheos-services-urls": "https://rheos-services.stratus.ebay.com",
        "event-time-field": "eventTimestamp",
        "deserializer": "com.ebay.tdq.connector.kafka.schema.PathFinderRawEventKafkaDeserializationSchema",
        "kafka-consumer": {
          "sasl.mechanism": "IAF",
          "security.protocol": "SASL_PLAINTEXT",
          "sasl.jaas.config": "io.ebay.rheos.kafka.security.iaf.IAFLoginModule required iafConsumerId=\"urn:ebay-marketplace-consumerid:68a97ac2-013b-4915-9ed7-d6ae2ff01618\" iafSecret=\"c4bb6fca-7ac5-46dd-b218-a49cb6307dbc\" iafEnv=\"production\";",
          "group.id": "tdq_pathfinder_prod",
          "bootstrap.servers": "rhs-swsvkiaa-kfk-lvs-1.rheos-streaming-prod.svc.38.tess.io:9092,rhs-swsvkiaa-kfk-lvs-2.rheos-streaming-prod.svc.38.tess.io:9092,rhs-swsvkiaa-kfk-lvs-3.rheos-streaming-prod.svc.38.tess.io:9092,rhs-swsvkiaa-kfk-lvs-4.rheos-streaming-prod.svc.38.tess.io:9092,rhs-swsvkiaa-kfk-lvs-5.rheos-streaming-prod.svc.38.tess.io:9092",
          "partition.assignment.strategy": "org.apache.kafka.clients.consumer.RoundRobinAssignor",
          "max.poll.records": 5000,
          "fetch.max.bytes": 52428800,
          "receive.buffer": 8388608,
          "fetch.max.wait.ms": 100,
          "max.partition.fetch.bytes": 10485760,
          "auto.offset.reset": "latest"
        }
      }
    }
  ],
  "rules": [
    {
      "name": "tdq_system",
      "type": "realtime.rheos.profiler",
      "config": {
        "window": "1min"
      },
      "profilers": [
        {
          "expr": "p1",
          "metric-name": "global_cnt_by_1min",
          "transformations": [
            {
              "alias": "p1",
              "expr": "count(1)"
            }
          ]
        }
      ]
    },
    {
      "name": "tdq_pathfinder_in_ido",
      "type": "realtime.rheos.profiler",
      "config": {
        "window": "5min"
      },
      "profilers": [
        {
          "metric-name": "common_metric",
          "expr": "total_cnt",
          "dimensions": [
            "domain",
            "site_id",
            "app",
            "page_id"
          ],
          "transformations": [
            {
              "alias": "soj_tag_p",
              "expr": "soj_tag('p')"
            },
            {
              "alias": "soj_tag_u",
              "expr": "soj_tag('u')"
            },
            {
              "alias": "soj_tag_t",
              "expr": "soj_tag('t')"
            },
            {
              "alias": "soj_tag_itm",
              "expr": "soj_tag('itm|itmid|itm_id|itmlist|litm')"
            },
            {
              "alias": "soj_tag_mav",
              "expr": "soj_tag('mav')"
            },
            {
              "alias": "soj_tag_dn",
              "expr": "soj_tag('dn')"
            },
            {
              "alias": "soj_tag_mos",
              "expr": "soj_tag('mos')"
            },
            {
              "alias": "soj_tag_osv",
              "expr": "soj_tag('osv')"
            },
            {
              "alias": "soj_tag_es",
              "expr": "soj_tag('es')"
            },
            {
              "alias": "soj_tag_app",
              "expr": "soj_tag('app')"
            },
            {
              "alias": "soj_tag_cpnip",
              "expr": "soj_tag('cpnip')"
            },
            {
              "alias": "soj_tag_icpp",
              "expr": "soj_tag('icpp')"
            },
            {
              "alias": "soj_tag_prof",
              "expr": "soj_tag('prof')"
            },
            {
              "alias": "soj_tag_clktrack",
              "expr": "soj_tag('!clktrack')"
            },
            {
              "alias": "soj_tag_eactn",
              "expr": "soj_tag('eactn')"
            },
            {
              "alias": "app",
              "expr": "soj_tag_app",
              "filter": "app in ('2571','1462','2878')"
            },
            {
              "alias": "page_id",
              "expr": "CAST(soj_tag_p AS INTEGER)",
              "filter": "page_id in (2547208,2483445,2047936,2054032,2053742,2045573,2351460,2381081)"
            },
            {
              "alias": "domain",
              "expr": "soj_page_family(CAST(soj_tag_p AS INTEGER))"
            },
            {
              "alias": "site_id",
              "expr": "CAST(soj_tag_t AS INTEGER)"
            },
            {
              "alias": "usr_id",
              "expr": "CAST(soj_tag_u AS LONG)"
            },
            {
              "alias": "total_cnt",
              "expr": "count(1)"
            },
            {
              "alias": "duration_sum",
              "expr": "sum(CAST(clientData.TDuration AS DOUBLE))"
            },
            {
              "alias": "gmt_usr_total_cnt",
              "expr": "count(1)",
              "filter": "domain in ('ASQ','BID','BIDFLOW','BIN','BINFLOW','CART','OFFER','UNWTCH','WTCH','XO') and IS_BBWOA_PAGE_WITH_ITM(page_id) and clientData.remoteIP not like '10.%'"
            },
            {
              "alias": "gmt_usr_cnt",
              "expr": "sum(case when LENGTH(soj_tag_u) > 0 then 1 else 0 end)",
              "filter": "domain in ('ASQ','BID','BIDFLOW','BIN','BINFLOW','CART','OFFER','UNWTCH','WTCH','XO') and IS_BBWOA_PAGE_WITH_ITM(page_id) and clientData.remoteIP not like '10.%'"
            },
            {
              "alias": "gmt_itm_total_cnt",
              "expr": "count(1)",
              "filter": "domain in ('ASQ','BID','BIDFLOW','BIN','BINFLOW','CART','OFFER','UNWTCH','VI','WTCH','XO') and IS_BBWOA_PAGE_WITH_ITM(page_id) and clientData.remoteIP not like '10.%'"
            },
            {
              "alias": "gmt_itm_cnt",
              "expr": "sum(case when LENGTH(soj_tag_itm) > 0 then 1 else 0 end)",
              "filter": "domain in ('ASQ','BID','BIDFLOW','BIN','BINFLOW','CART','OFFER','UNWTCH','VI','WTCH','XO') and IS_BBWOA_PAGE_WITH_ITM(page_id) and clientData.remoteIP not like '10.%'"
            },
            {
              "alias": "ebay_ip_cnt",
              "expr": "count(1)",
              "filter": "clientData.remoteIP like '10.%'"
            },
            {
              "alias": "bbwoa_pwi_cnt",
              "expr": "count(1)",
              "filter": "IS_BBWOA_PAGE_WITH_ITM(page_id)"
            },
            {
              "alias": "nt_dn_cnt",
              "expr": "sum(case when LENGTH(soj_tag_dn) > 0 then 1 else 0 end)"
            },
            {
              "alias": "nt_mav_cnt",
              "expr": "sum(case when LENGTH(soj_tag_mav) > 0 then 1 else 0 end)"
            },
            {
              "alias": "nt_mos_cnt",
              "expr": "sum(case when LENGTH(soj_tag_mos) > 0 then 1 else 0 end)"
            },
            {
              "alias": "nt_osv_cnt",
              "expr": "sum(case when LENGTH(soj_tag_osv) > 0 then 1 else 0 end)"
            },
            {
              "alias": "ep_site_incon_cnt",
              "expr": "sum(case when soj_tag_t = soj_tag_es then 0 else 1 end)",
              "filter": "soj_tag_es is not null"
            },
            {
              "alias": "ep_site_total_cnt",
              "expr": "count(1)",
              "filter": "soj_tag_es is not null"
            },
            {
              "alias": "ut_err_cnt",
              "expr": "sum(case when ((soj_tag_u similar to '\\d+' and (usr_id <= 0 or usr_id > 9999999999999999)) or soj_tag_u not similar to '\\d+') then 1 else 0 end)"
            },
            {
              "alias": "st_total_cnt",
              "expr": "count(1)",
              "filter": "page_id in (2047936,2054032,2053742,2045573) or (page_id in (2351460,2381081) and soj_tag_eactn is not null)"
            },
            {
              "alias": "st_cpnip_cnt",
              "expr": "sum(case when LENGTH(soj_tag_cpnip) > 0 then 1 else 0 end)",
              "filter": "page_id in (2047936,2054032,2053742,2045573) or (page_id in (2351460,2381081) and soj_tag_eactn is not null)"
            },
            {
              "alias": "st_icpp_cnt",
              "expr": "sum(case when LENGTH(soj_tag_icpp) > 0 then 1 else 0 end)",
              "filter": "page_id in (2047936,2054032,2053742,2045573) or (page_id in (2351460,2381081) and soj_tag_eactn is not null)"
            },
            {
              "alias": "st_prof_cnt",
              "expr": "sum(case when LENGTH(soj_tag_prof) > 0 then 1 else 0 end)",
              "filter": "page_id in (2047936,2054032,2053742,2045573) or (page_id in (2351460,2381081) and soj_tag_eactn is not null)"
            },
            {
              "alias": "st_clktrack_cnt",
              "expr": "sum(case when LENGTH(soj_tag_clktrack) > 0 then 1 else 0 end)",
              "filter": "page_id in (2047936,2054032,2053742,2045573) or (page_id in (2351460,2381081) and soj_tag_eactn is not null)"
            }
          ]
        },
        {
          "metric-name": "ep_qa_nqt",
          "expr": "qualified_events_cnt / total_cnt",
          "dimensions": [
            "expt_flow_type",
            "channel",
            "qual_age_target"
          ],
          "filter": "qual_timestamp is not null",
          "transformations": [
            {
              "alias": "soj_ec",
              "expr": "soj_nvl('ec')"
            },
            {
              "alias": "soj_eprlogid",
              "expr": "soj_nvl('eprlogid')"
            },
            {
              "alias": "tpool",
              "expr": "soj_nvl('TPool')"
            },
            {
              "alias": "channel",
              "expr": "case when soj_ec = '1' then 'Web' when soj_ec = '2' then 'Mobile Web' when soj_ec = '4' then 'Android' when soj_ec = '5' then 'iOS' when soj_ec = '6' then 'Email' else 'Unknown' end"
            },
            {
              "alias": "qual_timestamp",
              "expr": "to_timestamp(soj_parse_rlogid(soj_eprlogid, 'timestamp'))"
            },
            {
              "alias": "qual_age",
              "expr": "unix_timestamp(event_timestamp) - unix_timestamp(qual_timestamp)"
            },
            {
              "alias": "qual_age_group",
              "expr": "case when qual_age < 0 then 'Group: Error' when qual_age <= 1 then 'Group 1: 1 sec' when qual_age <= 2 then 'Group 2: 2 sec' when qual_age <= 10 then 'Group 3: 10 sec' when qual_age <= 60 then 'Group 4: 1 min' when qual_age <= 900 then 'Group 5: 15 min' when qual_age <= 3600 then 'Group 6: 1 hr' when qual_age <= 3600 * 12 then 'Group 7: 12 hr' when qual_age <= 86400 then 'Group 8: 1 day' when qual_age <= 86400 * 2 then 'Group 9: 2 days' when qual_age <= 86400 * 10 then 'Group 10: 10 days' else 'Group 11: > 10 days' end"
            },
            {
              "alias": "pool_type",
              "expr": "case when tpool in ('r1rover', 'r1pulsgwy', 'r1edgetrksvc') THEN 'T' else 'D' end"
            },
            {
              "alias": "expt_flow_type",
              "expr": "case when pool_type = 'T' and soj_ec in ('4', '5') then 'Native Client Side' when soj_ec in ('4', '5') then 'Native Server Side' else 'Native web, MWeb, DWeb' end"
            },
            {
              "alias": "qual_age_target",
              "expr": "case when expt_flow_type in ('Native Client Side') then '< 12 hours' else '< 10 second' end"
            },
            {
              "alias": "total_cnt",
              "expr": "count(1)"
            },
            {
              "alias": "qualified_events_cnt",
              "expr": "sum( case  when expt_flow_type in ('Native Client Side') and qual_age <= 3600 * 12 then 1  when expt_flow_type in ('Native web, MWeb, DWeb', 'Native Server Side') and qual_age <= 10 then 1  else 0 end)"
            }
          ]
        }
      ]
    }
  ]
}